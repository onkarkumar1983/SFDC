<apex:page standardController="TASKRAY__Project__c" sidebar="false"
    showheader="false" extensions="TASKRAY.trStandardController">
    <link href="{!URLFOR($Resource.trbootstrap, 'bootstrap/css/bootstrap.css')}" rel="stylesheet" type="text/css" />
    <link href="{!URLFOR($Resource.trplugins, 'jquery/custom-theme/jquery-ui-1.8.17.custom.css')}" rel="stylesheet" type="text/css" />
    <link href="{!URLFOR($Resource.trplugins, 'jquery/plugins/chosen.css')}" rel="stylesheet" type="text/css" />
    <link href="{!URLFOR($Resource.trplugins, 'jquery/plugins/colorpicker/css/colorpicker.css')}" rel="stylesheet" type="text/css" />
    <apex:includeScript value="{!URLFOR($Resource.TASKRAY__trplugins, 'jquery/jquery-1.7.1.min.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.TASKRAY__trplugins, 'jquery/jquery-ui-1.8.17.custom.min.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.TASKRAY__trbootstrap, 'bootstrap/js/bootstrap-collapse.js')}" />
	<apex:includeScript value="{!URLFOR($Resource.TASKRAY__trbootstrap, 'bootstrap/js/bootstrap-modal.js')}" />
	<apex:includeScript value="{!URLFOR($Resource.TASKRAY__trbootstrap, 'bootstrap/js/bootstrap-tooltip.js')}" />
	<apex:includeScript value="{!URLFOR($Resource.TASKRAY__trbootstrap, 'bootstrap/js/bootstrap-tab.js')}" />
	<apex:includeScript value="{!URLFOR($Resource.TASKRAY__trbootstrap, 'bootstrap/js/bootstrap-popover.js')}" />
	<apex:includeScript value="{!URLFOR($Resource.TASKRAY__trbootstrap, 'bootstrap/js/bootstrap-alert.js')}" />
	<apex:includeScript value="{!URLFOR($Resource.TASKRAY__trbootstrap, 'bootstrap/js/bootstrap-typeahead.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.TASKRAY__trplugins, 'jquery/plugins/jquery.loadmask.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.TASKRAY__trplugins, 'jquery/plugins/canvasloadermin.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.TASKRAY__trplugins, 'jquery/plugins/ui.multiselect.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.TASKRAY__trplugins, 'jquery/plugins/chosen.jquery.min.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.TASKRAY__trplugins, 'jquery/plugins/jquery.cookie.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.TASKRAY__trplugins, 'jquery/plugins/jquery.placeholder.min.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.TASKRAY__trplugins, 'jquery/plugins/colorpicker/js/bootstrap-colorpicker.js')}"/>
    
    <link href="{!URLFOR($Resource.trpopupcss)}" rel="stylesheet" type="text/css" />
    <link href="{!URLFOR($Resource.trplugins, 'jquery/plugins/ui.multiselect.css')}" rel="stylesheet" type="text/css" />
    <style type="text/css">
        #chatter-groups{
            width:100%;
        }
        
        #chatter_groups_chzn{
            margin-top: 5px;
            width:100% !important;
        }
        #chatter_groups_chzn input{
            width: 200px !important;
        }
        
        .modal-footer{
            padding-top: 6px !important;
            padding-bottom: 6px !important;
        }
        .tab-content{
            overflow: visible;
        }
        .sharing-user-pic{
        	height:36px;
        }
		/*bootstrap hacks*/
        .search-hidden{
            display:none;
        }
		.typeahead li{
			margin-left: 0 !important;
		}
		.nav-tabs .disabled{
			cursor: not-allowed;
			background-color:transparent;
			border-color: transparent;
		}
		.nav-tabs .disabled a:hover{
			cursor: not-allowed;
			background-color:transparent;
			border-color: transparent;
		}
		#details label{
			margin-bottom: 0px;
			margin-top: 5px;
		}
		#details input{
			margin-bottom: 0px;
		}
		#datePicker select{
			width: auto;
		}
		#chatterfeedshell textarea{
			box-shadow: none;
			border-width: 0px;
		}
		#chatterfeedshell textarea:hover{
			box-shadow: none;
		}
		#details .modal-footer{
			margin-top:20px;
		}
        /* Load Mask */
        .wrapper {
            left: 50%;
            position: absolute;
            top: 50%;
        }
        #canvasLoader{
            z-index:10000;
        }
        .dataCol input[type="checkbox"]{
            margin-top:6px;
        }
        .dataCol span span{
            margin-top:6px;
            display: inline-block;
        }
    </style>
    <script type="text/javascript">
    var sun32gif = '{!URLFOR($Resource.trplugins, 'images/sun32.png')}';
    var currentProjectId='';
    var loadType="{!JSENCODE($CurrentPage.parameters.type)}";
    var loadProjectId="{!JSENCODE(Project__c.Id)}";
    var loadTab="{!JSENCODE($CurrentPage.parameters.tab)}";
    var chatterGroupId="{!JSENCODE($CurrentPage.parameters.chatterGroupId)}";
    var parentProjectId="{!JSENCODE($CurrentPage.parameters.parentProjectId)}";
    var remove= '{!JSENCODE(URLFOR($Resource.trplugins, 'images/remove.png'))}';
    var autoFollowingTasks='{!autoFollowingCurrentProject}';
    var sharingEnabled; 
    $j = jQuery.noConflict();
    $j(document).ready(function(){
        if(typeof(Ext) !== 'undefined'){parent.Ext = Ext;}
        var groupId = '';
        
        
        $j(document).on('click','a', function() {
            if($j(this).attr('href')!== undefined){
                if($j(this).attr('href').indexOf('javascript')==-1 && $j(this).attr('href')!='#' && !$j(this).parent().parent().hasClass('nav-tabs'))
                {
                    window.open($j(this).attr('href'));
                    return false;
                }
            }
        });
    
           //do some quick dom changes to make titles look the way we want
        $j(this).find('.pageTitleIcon').css('background-image','url('+sun32gif+')');
        //$j(this).find('.pbTitle').first().html('<h2 class="mainTitle">Project Edit</h2>');
        $j(this).find('.pbSubheader.first').find('h3').text('Project Information');
        currentProjectId=$j('#projectId').val();
	
    	if((loadType=='new' && loadProjectId=='') || {!editMode} ){
    		disableEditTabs();
    	}
    	else{
    		contributorTabDisplayUpdate(currentProjectId);
    		attachProjectEditMethods();
    		if(loadTab!='' && $j('#'+loadTab).length > 0 && {!NOT(editMode)}){
    			$j('#'+loadTab+'-tab a').tab('show');
    		}
    	}
        $j('input, textarea').placeholder();

        //Init color picker
        $j('.fieldSet-'+'TASKRAY__'+'ProjectColor__c').colorpicker();

        //Add autofollow dom watching
        $j('.auto-follow-tasks-toggle').change(function(){
            var currentPageType='{!JSENCODE($CurrentPage.parameters.type)}';
            if( currentPageType != 'new'){
                parent.TASKRAY.trController.toggleProjectAutoFollow("{!TASKRAY__Project__c.Id}", function(event, result){
                    //console.log(result);
                });
            }
        });

        clearLoadMask();

        /*
         *  On form post-back close the dialog if a viariable has been
         *  set on the server side.
         */
        if({!closeDialog}){
            if(pageHasErrorMsg() == false){
                if($j.cookie('bltr_view')=='planning'){
                    parent.$j('.modal').modal('hide');
                    parent.planningViewLastEditedItem='{!JSENCODE(Project__c.Id)}';
                    parent.initPage();
                }
                else{
                    if(parent.currentBoardId == 'project')
                    {
                        parent.currentProjectId = '{!JSENCODE(Project__c.Id)}';
                        parent.initPage();
                    }
                    else{
                        parent.initPage();
                    }
                    parent.$j('.modal').modal('hide');
                }
            }
        }

        if(parentProjectId){
            var parentProjectName = '';
            $j.each(parent.sidebarProjectInfo,function(index,obj){
                if(obj.project.Id == parentProjectId){
                    parentProjectName = obj.project.Name;
                    return false;
                }
            });
            $j('.fieldSet-'+'TASKRAY__'+'Project_Parent__c').val(parentProjectName);
        }

    //end doc ready
    });

	function disableEditTabs(){
		$j('#contributors-tab').addClass('disabled');
		$j('#contributors-tab').click(function(e){e.stopPropagation();});
		$j('#group-tab').addClass('disabled');
		$j('#group-tab').click(function(e){e.stopPropagation();});
	}
	
	function attachProjectEditMethods(){
		        if(parent.chatterGroupIds != null){
            $j(parent.chatterGroupIds).each(function(i,o){
                groupId = o;
                $j('option').each(function(j,element){
                    if($j(element).val() == groupId){
                        $j(element).attr('selected','selected');
                    }
                });
                shareProjectsWithChatter(function(){ return 0; });
            });
        }
        $j('#chatter-groups').chosen();
        $j('.save-chatter-groups').click(function(){
            if($j(this).attr('closeDialog')=='true'){
                shareProjectsWithChatter(function(){
                    //console.log('updated chatter sharing');
                    parent.initPage();
                    parent.planningViewLastEditedItem='{!JSENCODE(Project__c.Id)}';;
                    parent.$j('.modal').modal('hide');
                });
            }
            else{
                shareProjectsWithChatter(function(){
                    //console.log('updated chatter sharing');
                    parent.planningViewLastEditedItem='{!JSENCODE(Project__c.Id)}';;
                    parent.initPage();
                });
            }
        });
        $j("#project-edit-content a[target!='_self']").each(function(element){ 
            if(typeof($j(this).attr('href')) !== 'undefined'){
                if($j(this).attr('href').indexOf("http") >= 0)
                {
                    $j(this).attr('target','_blank');
                }
            }
        });
           
        $j(".dataCol span:contains('<a href=')").each(function(){
            $j(this).html($j(this).text());
        });
        
        $j('.delete-btn').click(function(e){
            e.preventDefault();
            $j("#delete-confirm").modal('show');
        });
        
        $j('.archive-project-btn').click(function(e){
            e.preventDefault();
            $j("#archive-confirm").modal('show');
        });
        
        $j('.clone-project-btn').click(function(e){
            $j("#clone-confirm").modal('show');
        });
        
        $j('#delete-confirm-btn').click(function(){
        showLoadMask(function(){});
        parent.TASKRAY.trController.markProjectDeleted("{!TASKRAY__Project__c.Id}", function(event, result){
            if (result.status) {
                if(parent.currentBoardId == 'project')
                {
                    //parent.populateProjects(parent.refreshTasks());
                }
                else{
                    //parent.populateProjects(parent.refreshTasks());
                }
                parent.initPage();
                parent.dialogOpen = false;
                parent.$j('.modal').modal('hide');
            }
            else{
                alert("There was an issue with deleting this record: "+result.message.replace('"','\"'));
            }
            clearLoadMask();
            }, {
                escape: true
            });
        });
    
        $j('#archive-confirm-btn').click(function(){
            parent.TASKRAY.trController.archiveProject("{!TASKRAY__Project__c.Id}", function(event, result){
                if (result.status) {
                    if(parent.currentBoardId == 'project')
                    {
                        parent.currentProjectId = '{!JSENCODE(Project__c.Id)}';
                        //parent.populateProjects(parent.refreshTasks());
                    }
                    else{
                        //parent.populateProjects(parent.refreshTasks());
                    }
                    parent.initPage();
                    parent.dialogOpen = false;
                    parent.$j('.modal').modal('hide');
                }
                else{
                    alert("There was an issue with archiving this record: "+escape(result.message.replace('"','\"')));
                }
            });    
        });


        //Does the two tab saving logic
        $j('.save-project-contribandgroup').unbind('click');
        $j('.save-project-contribandgroup').click(function(){
            saveContribAndGroup($j(this),true);
        });
        
        
	}
	

    function saveContribAndGroup(thisItem,clearLoadMaskAfter){
        showLoadMask(function(){});
        $j('.save-project-contribandgroup').removeAttr('isclicked');
        $j(thisItem).attr('isclicked','true');

        if($j(thisItem).attr('closeDialog')=='true'){
            shareProjectsWithChatter(function(){
                //console.log('updated chatter sharing');
                if(clearLoadMaskAfter){ clearLoadMask(); }
                parent.planningViewLastEditedItem='{!JSENCODE(Project__c.Id)}';;
                parent.initPage();
                parent.$j('.modal').modal('hide');
            });
        }
        else{
            shareProjectsWithChatter(function(){
                //console.log('updated chatter sharing');
                if(clearLoadMaskAfter){ clearLoadMask(); }
                parent.planningViewLastEditedItem='{!JSENCODE(Project__c.Id)}';
                parent.initPage();
            });
        }
        if(sharingEnabled){
            if($j(thisItem).attr('closeDialog')=='true'){updateUserInvites(function(){if(clearLoadMaskAfter){ clearLoadMask(); }parent.$j('.modal').modal('hide');});}
            else{ 
                if($j(thisItem).attr('changenext')=='true'){
                    updateUserInvites(function(){refreshSharingTable(function(){if(clearLoadMaskAfter){ clearLoadMask(); } });$j('#group-tab > a').tab('show');}); 
                }
                else{
                    updateUserInvites(function(){refreshSharingTable(function(){ if(clearLoadMaskAfter){ clearLoadMask(); } });});
                }
            }
        } else {
            if($j(thisItem).attr('closeDialog')=='true'){ 
                updateContributorInvites(function(){ 
                    parent.$j('.modal').modal('hide');}
                );
            } else {
                if($j(thisItem).attr('changenext')=='true'){
                    updateContributorInvites(function(){
                        refreshContributorsTable(function(){ if(clearLoadMaskAfter){ clearLoadMask(); } });
                        $j('#group-tab > a').tab('show');
                    });
                }else{
                    updateContributorInvites(function(){
                        refreshContributorsTable(function(){ if(clearLoadMaskAfter){ clearLoadMask(); } });
                    });
                }
            }
        }
    }



	/* 
	 *	contributorTabInit()
	 *	Initialize the contributors tab when sharing isn't enabled
	 */
	function contributorTabInit(){
		var searchResultObjs={};
		parent.TASKRAY.trController.isProjectSharingEnabled(function(event, result){
			if(result.result){$j('#contributors-warning-sharing-enabled').show();}
			else{$j('#contributors-warning-no-sharing').show();}
			//ifcontributors-warning-no-sharing
		});
	   	$j('#add-contributor-search').typeahead({
    		source: function(query,process) {
 		   		var contributors = [];
		   		$j('.contributor-row').each(function(i,o){
		   			contributors.push($j(o).attr('id'));
		   		});
    			parent.TASKRAY.trController.projectContributorSearch_v2(query,contributors,function(event,results){
    				var result_list = [];
    				var result_objs = [];
    				$j.each(results.result,function(index,o){
                        o.Name= (o.UserRoleName !=null) ? o.Name+" ("+o.UserRoleName+")"+"<div class='search-hidden'>"+o.Id+"</div>" : o.Name+"<div class='search-hidden'>"+o.Id+"</div>";
    					searchResultObjs[o.Name]=o;
    					result_list.push(o.Name);
    				});
    				process(result_list);
    				this.source=result_objs;
    			});
    		},
    		updater: function(item){
    			o=searchResultObjs[item];
    			addContributorSelect(o);
    			//addContributorTableRow(o,true);
    			//attachContributorTableClickHandlers();
    		},
    		minLength: 3
   		});
   		$j('#allinternaluserscheckbox-unshare').unbind('change');
   		$j('#allinternaluserscheckbox-unshare').change(function(e){
   			if(!$j(this).is(':checked')){
   				$j('#delete-all-internal-share-modal').modal('show');
   			}
   		});
   		$j('#delete-all-internal-share-confirm-btn').unbind('click');
   		$j('#delete-all-internal-share-confirm-btn').click(function(e){
   			$j('#delete-all-internal-share-modal').modal('hide');
            //Show a load mask while this is running
            showLoadMask(function(){});
   			//Do the remote action for deleting the share and bouncing the pane
   			parent.TASKRAY.trController.toggleAllInternalUserSharing(currentProjectId, 'removeshare',function(even,results){
   				//console.log(results.result);
   				if(results.result=='share removed'){
   				//refresh logic
   				parent.initPage();
   				contributorTabDisplayUpdate(currentProjectId);
   				}
   				else{
   				//error logic
                alert(results.message);
   				}
                clearLoadMask(function(){});
   			});
   		});
   		
        $j('input, textarea').placeholder();
   		
	}
	
	function contributorTabSharingInit(){
		refreshSharingTable();
		//addSaveButtonClickHandler();    
		var searchResultObjs={};
		$j('#sharing-add-contributor-search').typeahead({
    		source: function(query,process) {
    			parent.TASKRAY.trController.projectSharingUGSearchResults(query,currentProjectId,function(event,results){
    				var result_list = [];
    				var result_objs = [];
    				$j.each(results.result,function(index,o){
    					//console.log(o);
    					searchResultObjs[o.userOrGroupName]=o;
    					result_list.push(o.userOrGroupName);
    				});
    				process(result_list);
    				this.source=result_objs;
    			});
    		},
    		updater: function(item){
    			o=searchResultObjs[item];
    			addSharingTableRow(o,true);
    			attachSharingTableClickHandlers();
    		},
    		minLength: 3
   		});
   		$j('#allinternaluserscheckbox-share').unbind('change');
   		$j('#allinternaluserscheckbox-share').change(function(e){
   			if($j(this).is(':checked')){
   				$j('#add-all-internal-share-modal').modal('show');
   			}
   		});
   		$j('#add-all-internal-share-confirm-btn').unbind('click');
   		$j('#add-all-internal-share-confirm-btn').click(function(e){
   			$j('#add-all-internal-share-modal').modal('hide');
            //Show load mask while this is running
            showLoadMask(function(){});
   			//Do the remote action for adding the share and bouncing the pane
   			parent.TASKRAY.trController.toggleAllInternalUserSharing(currentProjectId, 'addshare',function(even,results){
   				//console.log(results.result);
   				if(results.result=='share added'){
   				//refresh logic
   				parent.initPage();
   				contributorTabDisplayUpdate(currentProjectId);
   				}
   				else{
   				//error logic
                alert(results.message);
   				}
                clearLoadMask(function(){});
   			});
   		});

        $j('input, textarea').placeholder();
	}
	

    if({!refresh}){
        if($j.cookie('bltr_view')=='planning'){
            parent.planningViewLastEditedItem='{!JSENCODE(Project__c.Id)}';
        }
        parent.initPage();
    }
    

    function pageHasErrorMsg(){
        return !$j('.messageTable').length==0;
    }

    /*
     *  
     */
    function storeChatterGroupIdsOnParent(){
        var ids = [];
        $j('#chatter-groups').children(':selected').each(function(i,o){
            ids.push($j(o).val());
        });
        // new project, save the chatter group ids to the parent until after record is saved    
        parent.chatterGroupIds = ids;
    }
    
    /*
     *  Updates the list of Chatter groups that the current project is
     *  shared with
     */
    function shareProjectsWithChatter(callback){
        var ids = [];
        $j('#chatter-groups').children(':selected').each(function(i,o){
            ids.push($j(o).val());
        });
        // new project, save the chatter group ids to the parent until after record is saved    
        parent.chatterGroupIds = ids;
        //console.log('Sharing Project Id: '+parent.chatterGroupIds);
        if($j('#projectId').val() != ''){
            parent.TASKRAY.trController.updateProjectGroupSharing(ids,$j('#projectId').val(),function(status,result){
                callback(); 
            }, {
                escape: true
            });
        }
    }
    
    
    function cloneProject(){
        showLoadMask(function(){});
        projectInfoObj={};
        projectInfoObj.projectId=$j('#projectId').val();
        projectInfoObj.newProjectName=$j('#new-project-title').val();
        projectInfoObj.newStartDate=$j('.newCloneStartDate').val();
        projectInfoObj.newEndDate=$j('.newCloneEndDate').val();
        projectInfoObj.cloneChildrenProjects=($j('#cloneChildren').is(':checked')) ? 'true' : 'false';
        //projectInfoObj.assignInactiveToCurrent=($j('#assignInactiveToCurrent').is(':checked')) ? 'true' : 'false';
        projectInfoObj.assignInactiveToCurrent='true';
        parent.TASKRAY.trController.cloneProjectReturnId_v2(projectInfoObj, function(status,result){ 
            if (result.status) {
	            parent.populateProjects(parent.refreshTasks);
	            $j('#clone-confirm').modal('hide');
	            parent.$j('.modal').modal('hide');
	            var newProjectId=result.result;
	            $j.cookie('apex__bltrProjectId', newProjectId, {
					expires : 365,
					path : '/',
					secure : true
				});
                if(parent.newTaskRayUI){
                    parent.getAndProcessBoardData(function(){parent.toggleProjectFunnel(newProjectId, 'hierarchy');});
                    parent.$j('.modal').modal('hide');
                } else{
                    parent.window.location = parent.trProjectBoardPage;
                }
				
	        }
	        else{
	        	alert("An exception occurred while cloning this project:\n\n"+result.message);
	        }
            clearLoadMask();
        });
    }
    
    //Contributor tab functions
    /*
     *  function contributorTabDisplayUpdate
     */
    function contributorTabDisplayUpdate(projectId){
        parent.TASKRAY.trController.isProjectSharedToAllInternalUsers(projectId, function(e,r){
            if(r.result == false){
                $j('#allinternaluserscheckbox-share').attr('checked',false);
                $j('#projectSharing').show();
                $j('#projectContributors').hide();        
                contributorTabSharingInit();
                sharingEnabled = true;
            }
            else{
                $j('#allinternaluserscheckbox-unshare').attr('checked',true);
                $j('#projectSharing').hide();
                $j('#projectContributors').show();
                
                fetchCurrentContributorsNameList();
                contributorTabInit();
                sharingEnabled = false;
            }
        });
    }
    
    /*
     * AddContributorSelect()
     * Handle the selection of a contributor from the search results
     */
    function addContributorSelect(){
        if($j('#add-contributor option:selected').html()!=''){
        	addContributorTableRow(o);
            $j("#add-contributor").html("<option></option>");
            $j("#add-contributor").trigger("liszt:updated");
        }
    }
    
    /* 
     *	addContributorTableRow(o)
     *	Adds contributors to the rows
     */
    function addContributorTableRow(o){
    	o.Name= (o.UserRoleName !=null && o.Name.indexOf(o.UserRoleName) == -1) ? o.Name+" ("+o.UserRoleName+")" : o.Name;
        $j('#contributors-table').append('<tr id="'+o.Id+'" class="unsaved-contributor-row" ><td><img src="'+o.SmallPhotoUrl+'" style="height:36px;"/><span>&nbsp;'+o.Name+'&nbsp;<span class="label label-warning unsaved-label">Unsaved</span></span></td><td><img class="remove-contributor" src="'+remove+'" style="cursor:pointer; margin: 10px; width:16px;" /></td></tr>');
		addContributorRemoveClickHandler();
		$j("#add-contributor").html("<option></option>");
		$j("#add-contributor").trigger("liszt:updated");
    }
    
    /*
     * updateUserInvites
     * Added a 'previous' check to see if the checkboxes have been checked or unchecked to display a confirming message
     * warning the user about the change in access to Project.
     */
    function updateUserInvites(callback){
        var rows = [];
        var toConfirm = false;
        var currentProjectId = $j('#projectId').val();
        
        $j('.result-row').each(function(i,o){
            $j(o).css('background-color','#fff');
            var userRow = {};
            userRow['id'] = $j(o).attr('id');
            userRow['isowner'] = $j(o).attr('isowner');
            userRow['name'] = $j('#'+userRow['id']+'-name').text();
            userRow['read'] = $j('#'+userRow['id']+'-readonly').is(':checked');
            userRow['previousRead'] = ($j('#'+userRow['id']+'-readonly').attr('previous') == "true");
            userRow['write'] =  $j('#'+userRow['id']+'-readwrite').is(':checked');
            userRow['previousWrite'] = ($j('#'+userRow['id']+'-readwrite').attr('previous') == "true");
            var accessLevel = ''
            if(userRow['read'] && userRow['write']){
                userRow['accessLevel'] = 'Edit';
            } else if (userRow['read'] && !userRow['write']){
                userRow['accessLevel'] = 'Read';
            } else{
                userRow['accessLevel'] = 'Remove';
            }
            if(userRow['isowner']!='true'){rows.push(userRow);}
        });
        
        var userAccessMap={};
        $j(rows).each(function(i,o){
        	userAccessMap[o.id]=o.accessLevel;
        });
        
        parent.TASKRAY.trController.saveProjectSharing_bulk($j('#projectId').val(), userAccessMap,function(e,r){
        	if(!r.status){
                alert(r.message);
            }
            if( typeof callback === 'function') {
                        callback();
            }
        },{ buffer: false, timeout: 120000 });
        
        if(rows.length==0){
            if( typeof callback === 'function') {
                callback();
            }
        }
    }
    
    function refreshSharingTable(callback){
        parent.TASKRAY.trController.getUserNamesAndAccessForProject(currentProjectId,function(event,results){
                $j('#current-shares-table .result-row').remove();
                if(results.status == true){
                	var resultsSorted=[];
                	$j.each(results.result,function(i,o){
                		resultsSorted.push(o);
                	});
                	//Sort by contributor then by user.Name
	            	function sortF(ob1,ob2) {
					    if (ob1.isOwner == true && ob2.isOwner==false) {
					        return -1;
					    } else if (ob1.isOwner == false && ob2.isOwner==true) {
					        return 1;
					    }
					
					    // Else go to the 2nd item
					    if (ob1.userOrGroupName < ob2.userOrGroupName) { 
					        return -1;
					    } else if (ob1.userOrGroupName > ob2.userOrGroupName) {
					        return 1
					    } else { // nothing to split them
					        return 0;
					    }
					}
					resultsSorted.sort(sortF);
                    $j.each(resultsSorted,function(i,o){
                        addSharingTableRow(o);
                    });
                    attachSharingTableClickHandlers();
                }
                if( typeof callback === 'function') {
                    callback();
                }
            }, {
           escape : true
        }); 
    }

    function addSharingTableRow(o,isNew){
        var readOnlyCheckbox = '';
        var readWriteCheckbox = '';
        var label = '';
        if($j('#project-records-sharing-level').val() == "true" || o.isOwner == true){
            readOnlyCheckbox = '<input id="'+o.userOrGroupID+'-readonly" class="read-checkbox" type="checkbox" previous="true" checked="checked" disabled="disabled"  />';
        } else{
            if(o.readAccess){
                readOnlyCheckbox = '<input id="'+o.userOrGroupID+'-readonly" class="read-checkbox" previous="true" type="checkbox" checked="checked" +  />';
            }else if(isNew){
            	readOnlyCheckbox = '<input id="'+o.userOrGroupID+'-readonly" class="read-checkbox" previous="false" type="checkbox" checked="checked" +  />';
            }
            else{
                readOnlyCheckbox = '<input id="'+o.userOrGroupID+'-readonly" class="read-checkbox" previous="false" type="checkbox" />';    
            }
        }
        if(o.isOwner == true){
            readWriteCheckbox = '<input id="'+o.userOrGroupID+'-readwrite" type="checkbox" previous="true" checked="checked" disabled="disabled" />';
        } else{
            if(o.readWriteAccess){
                readWriteCheckbox = '<input id="'+o.userOrGroupID+'-readwrite" class="write-checkbox" previous="true" type="checkbox" checked="checked" />';
            }else if(isNew){
            	readWriteCheckbox = '<input id="'+o.userOrGroupID+'-readwrite" class="write-checkbox" previous="false" type="checkbox" checked="checked" />';
            }
            else{
                readWriteCheckbox = '<input id="'+o.userOrGroupID+'-readwrite" class="write-checkbox" previous="false" type="checkbox" />'; 
            }
        }
        if(o.isOwner == true){
            label = '&nbsp;<span class="label label-info">Project Owner</span>'
        }
        if(o.userOrGroup == 'group'){
            label = '&nbsp;<span class="label label-info">Group</span>'
        }
        if(isNew==true){
            label = '&nbsp;<span class="label label-warning">Unsaved</span>'
        }
        var unsavedStr= (isNew) ? 'unsaved="true"' : '';
        var imgStr= (o.smallPhotoUrl =='') ? '' : '<img class="sharing-user-pic" src="'+o.smallPhotoUrl+'" />';
        var isOwnerStr= (o.isOwner ==true) ? 'isOwner="true"' : 'isOwner="false"';
        $j('#current-shares-table tbody').append('<tr '+unsavedStr+' class="result-row" id="'+o.userOrGroupID+'" '+isOwnerStr+'><td>'+imgStr+'</td><td id="'+o.userOrGroupID+'-name" style="min-width:275px;">'+o.userOrGroupName+label+'</td><td style="text-align:center;"text-align:center;">'+readOnlyCheckbox+'</td><td style="text-align:center;">'+readWriteCheckbox+'</td></tr>');
    }
    
    function attachSharingTableClickHandlers(){
        /* 
         * For check the 'read only checkbox' and deactivate it 
         */
        $j('.write-checkbox').change(function(){
            var checkbox = $j('#'+$j(this).parents('tr').attr('id')+'-readonly');
            if($j(this).is(':checked')){
                checkbox.prop('disabled',true);
            }
            else{
                checkbox.prop('disabled',false);
            }
            if(!checkbox.is(':checked')){
                checkbox.prop('checked',true);
            }
        });
        
        $j('.read-checkbox').change(function(){
            var checkbox = $j('#'+$j(this).parents('tr').attr('id')+'-readwrite');
            if(!$j(this).is(':checked')){
                checkbox.prop('disabled',true);
            }
            else{
                checkbox.prop('disabled',false);
            }
            if(checkbox.is(':checked')){
                checkbox.prop('checked',false);
            }
        });
    }
    
    function refreshContributorsTable(callback){
    	$j('#contributors-table').find('tr').remove();
    	fetchCurrentContributorsNameList(callback);
    }
    
    /*
     *  fetchCurrentContributorsNameList
     *  loads a list of usernames that are current contributors to the selected project
     */
    function fetchCurrentContributorsNameList(callback){
        $j('#contributors-table tr').remove();
        parent.TASKRAY.trController.getCurrentContributorsList($j('#projectId').val(),function(event,result){
            if(result.status){
            	//Sort by contributor then by user.Name
            	function sortF(ob1,ob2) {
				    if (ob1.contributor == true && ob2.contributor==false) {
				        return 1;
				    } else if (ob1.contributor == false && ob2.contributor==true) {
				        return -1;
				    }
				
				    // Else go to the 2nd item
                    var ob1Name = (typeof(ob1.user) === 'undefined') ? ob1.contribGroup.Name : ob1.user.Name;
                    var ob2Name = (typeof(ob2.user) === 'undefined') ? ob2.contribGroup.Name : ob2.user.Name;


				    if (ob1Name < ob2Name) { 
				        return -1;
				    } else if (ob1Name > ob2Name) {
				        return 1
				    } else { // nothing to split them
				        return 0;
				    }
				}
				event.sort(sortF);
                $j.each(event,function(i,o){
                    var nameString;
                    if(typeof(o.user) !== 'undefined'){
                        nameString = (typeof(o.user) !== 'undefined' && o.user.UserRole != null && o.user.UserRole.Name !=null) ? o.user.Name+" ("+o.user.UserRole.Name+")" : o.user.Name ;
                    }else{
                        nameString = '<span>'+o.contribGroup.Name+'&nbsp;<span class="label label-info">{!JSENCODE($Label.TaskRay_ProjectModal_GroupStringForContrib)}</span></span>';
                    }

                    if(!o.contributor){
                    	$j('#contributors-table').append('<tr class="contributor-row" id="'+o.user.Id+'"><td><img src="'+o.user.SmallPhotoUrl+'" style="height:36px;"/>&nbsp;'+nameString+'</td><td></td></tr>');
                	} else {
                        if(o.user != null){
                            $j('#contributors-table').append('<tr class="contributor-row" id="'+o.user.Id+'"><td><img src="'+o.user.SmallPhotoUrl+'" style="height:36px;"/>&nbsp;'+nameString+'</td><td><img id="'+o.contributorId+'" class="remove-contributor" src="'+remove+'" style="cursor:pointer; width:16px; margin:10px;"/></td></tr>');
                        }
                        else if(o.contribGroup != null){
                            $j('#contributors-table').append('<tr class="contributor-row" id="'+o.contribGroup.Id+'"><td><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" style="height:36px;"/>&nbsp;'+nameString+'</td><td><img id="'+o.contributorId+'" class="remove-contributor" src="'+remove+'" style="cursor:pointer; width:16px; margin:10px;"/></td></tr>');
                        }
                		
                	}
                });
                addContributorRemoveClickHandler();
            }
            if(typeof(callback)=='function'){callback();}
        });
    }
    
    /* 
     *	addContributorRemoveClickHandler()
     *	Removes the contributor row and contributor from the database as necessary
     */
    function addContributorRemoveClickHandler(){
    	$j('.remove-contributor').unbind('click');
	   $j('.remove-contributor').on('click',function(e){
	   	
	   	if($j(this).attr('id') != undefined){
	   		var id = $j(this).attr('id');
	   		$j(this).parents('tr').remove();
		   	parent.TASKRAY.trController.removeContributorFromProject(id,function(e,r){
                if(r.status){
		   			parent.refreshSidebarUserPhotos();		
		   		}
		   	});
		   	
	   	} else {
	   		$j(this).parents('tr').remove();
	   	}
	   });
    }
    
    function updateContributorInvites(callback){
    	var ids = [];
    	$j('.unsaved-contributor-row').each(function(i,o){
    		ids.push($j(o).attr('id'));
    	});
    	
    	parent.TASKRAY.trController.addProjectContributors(ids,currentProjectId,function(e,r){
    		parent.refreshSidebarUserPhotos();
    	});
    	
    
    	callback();
    }
    if(( '{!JSENCODE($CurrentPage.parameters.type)}' == 'new' && {!closeDialog} ) || ( '{!JSENCODE($CurrentPage.parameters.type)}' == 'new' && '{!JSENCODE($CurrentPage.parameters.tab)}' == 'contributors' )  ){
    	$j.cookie('apex__bltrProjectId', '{!JSENCODE(Project__c.Id)}', {
			expires : 365,
			path : '/',
			secure : true
		});
        if(parent.newTaskRayUI){
            parent.initPage(function(){parent.toggleProjectFunnel('{!JSENCODE(Project__c.Id)}', 'onlythis');});
        } else {
            parent.initPage();
        }

    }

    function showLoadMask(callback) {
        $j("#canvasloader-container").empty();
        $j("#modal-backdrop-loadmask").show();
        $j("#canvasloader-container").show();
        var cl = new CanvasLoader('canvasloader-container');        
        cl.setColor('#0099ff');
        // default is '#000000'
        cl.setDiameter(84);
        // default is 40
        cl.setDensity(75);
        // default is 40
        cl.setRange(1);
        // default is 1.33
        cl.setFPS(26);
        // default is 24
        cl.show();
        // Hidden by default
        // This bit is only for positioning - not necessary
        $j("#canvasLoader").css('margin-top', ($j("#canvasLoader").outerHeight() / 2) * -1);
        $j("#canvasLoader").css('margin-left', ($j("#canvasLoader").outerWidth() / 2) * -1);
        $j("#canvasLoader").css('position','fixed');
        $j("#canvasLoader").css('top',$j(window).height()/2);
        $j("#canvasLoader").css('left',$j(window).width()/2);
        /*loaderObj.style.position = "absolute";
        loaderObj.style["top"] = cl.getDiameter() * -0.5 + "px";
        loaderObj.style["left"] = cl.getDiameter() * -0.5 + "px";*/
        
    }

    function clearLoadMask(callback){
        $j("#canvasloader-container").empty();
        $j("#modal-backdrop-loadmask").hide();
    }
    
</script>
<div id="project-edit-content">
    <div class="campaignTab" style="padding: 5px 15px 15px 15px;">
        
	        <apex:outputPanel rendered="{!NOT(currentProject.Name == null)}">
	            <apex:sectionHeader title="TaskRay" subtitle="{!currentProject.Name}" />
	        </apex:outputPanel>
            <apex:pageMessages />
	        <apex:outputPanel rendered="{!(currentProject.Name == null)}">
	            <script type="text/javascript">parent.chatterGroupIds = null;</script>
	            <apex:sectionHeader title="TaskRay" subtitle="New Project" />
	        </apex:outputPanel>
	        <ul class="nav nav-tabs">
	            <li class="active"><a href="#details" data-toggle="tab">Details</a></li>
	            <li id="contributors-tab"><a href="#contributors" data-toggle="tab">Contributors</a></li>
	            <li id="group-tab"><a href="#groups" data-toggle="tab">Groups</a></li>
	        </ul>
        
        <div id="myTabContent" class="tab-content">
            <div class="tab-pane fade active in" id="details">
                <apex:form >
                <apex:outputPanel id="newprojectid">
                    <input type="hidden" id="projectId" value="{!TASKRAY__Project__c.Id}" />
                    <input type="hidden" id="projectName" value="{!Project__c.Name}" />
                </apex:outputPanel>
                    <apex:actionFunction name="archiveProject" action="{!archiveProject}" oncomplete="runArchive();" />
                    <apex:pageBlock id="projectDetails" mode="edit">
                        <apex:pageBlockSection columns="2">
                            <apex:repeat value="{!$ObjectType.TASKRAY__Project__c.FieldSets.TASKRAY__Projects_Field_Set}" var="f">
                                <apex:outputField value="{!currentProject[f]}" rendered="{!NOT(editMode) || CONTAINS(f.FieldPath,'__r')}" />
                                <apex:inputField styleClass="fieldSet-{!f}" value="{!currentProject[f]}" required="{!f.required}" rendered="{!editMode && !CONTAINS(f.FieldPath,'__r')}" />
                            </apex:repeat>
                        </apex:pageBlockSection>
                        <!-- <apex:pageBlockButtons >  -->
                        <div class="modal-footer">
                            <div class="pull-left"><label class="checkbox"><apex:inputCheckbox styleClass="auto-follow-tasks-toggle" value="{!autoFollowingCurrentProject}"/>Auto-Follow Tasks</label></div>
                            <!-- Added $ObjectType.Project__c.updateable check, Jordan, 2/28/2012-->
                            <apex:commandLink styleClass="btn-bs" action="{!cancel}" onclick="parent.$j('.modal').modal('hide');" value="Cancel" rendered="{!userEditAccess && NOT(editMode)}" />
                            <apex:commandLink styleClass="btn-bs" action="{!cancelEdit}" value="Cancel" rendered="{!userEditAccess && editMode}" />
                            
                            <apex:commandLink styleClass="btn-bs btn-bs-primary" action="{!changeForm}" value="Edit" style="color: #ffffff;" rendered="{!(userEditAccess && $ObjectType.TASKRAY__Project__c.updateable && NOT(editMode))}" onclick="saveContribAndGroup($j('.save-project-contribandgroup').first(),false);showLoadMask(function(){});"/>
                            <!-- Added $ObjectType.Project__c.deletable check, Jordan, 2/28/2012-->
                            <apex:commandLink styleClass="delete-btn btn-bs" value="Delete" rendered="{!(userAllAccess && NOT(currentProject.Name==null) && $ObjectType.TASKRAY__Project__c.deletable && NOT(editMode) )}" reRender="noRefresh"/>
                            <apex:commandLink styleClass="archive-project-btn btn-bs" value="Archive" rendered="{!(userEditAccess && NOT(currentProject.Name == null) && $ObjectType.TASKRAY__Project__c.updateable && NOT(editMode))}" reRender="noRefresh"/>
                            <apex:commandLink styleClass="clone-project-btn btn-bs" value="Clone" rendered="{!userEditAccess && NOT(currentProject.Name==null) && NOT(editMode)}" reRender="noRefresh"/>
                            <apex:commandLink styleClass="btn-bs btn-bs-primary" action="{!saveAndDontClose}" value="Save" rendered="{!($ObjectType.TASKRAY__Project__c.updateable && editMode == true && $CurrentPage.parameters.type != 'new' )}"/>
                            <apex:commandLink styleClass="btn-bs btn-bs-primary" action="{!saveAndDontClose}" value="Save & Next" rendered="{!($ObjectType.TASKRAY__Project__c.createable && (currentProject.Name == null || ($CurrentPage.parameters.type == 'new' && editMode)) )}"/>
                            <apex:commandLink styleClass="btn-bs" action="{!saveAndClose}" value="Save & Close" rendered="{!($ObjectType.TASKRAY__Project__c.updateable && editMode == true) || ($ObjectType.TASKRAY__Project__c.createable && currentProject.Name == null)}" onClick="showLoadMask();"/>
                        </div>
                        <!-- </apex:pageBlockButtons> -->
                    </apex:pageBlock>
                </apex:form>
                    
                <chatter:feedWithFollowers entityId="{!currentProject.Id}"></chatter:feedWithFollowers>
            </div>
	        <div class="tab-pane fade in" id="contributors" style="width:100%">
	            <div id="projectContributors" style="display:none;">
	            	<apex:outputPanel rendered="{!sharingEnabled}">
	            	<div class="all-internal-user-sharing-container">
	            		<input type="checkbox" id="allinternaluserscheckbox-unshare" checked="checked"></input> <label for="allinternaluserscheckbox-unshare">Share this project to All TaskRay Users</label>
	            	</div>
	            	</apex:outputPanel>
	            	<div style="clear:both;"></div>
	            	<hr style="margin: 4px;"/>
	            	<div id="contributors-warning-sharing-enabled" class="alert alert-success" style="display:none">
	            		<b>This project is PUBLIC.</b><br />
	            		The users below are currently listed as contributors, but any TaskRay user may access this project. Contributors may be added using the look-up field and deleted by clicking the 'x' icon. Contributors without an 'x' icon available are project or task owners.
	            	</div>
	            	<div id="contributors-warning-no-sharing" class="alert alert-success" style="display:none">
	            		The users below are currently listed as contributors. Contributors may be added using the look-up field and deleted by clicking the 'x' icon. Contributors without an 'x' icon available are project or task owners.
	            	</div>
	            	<table id="contributors-table" class="table table-condensed">
	                </table>
	                <input id="add-contributor-search" placeholder="Search for a new contributor..." ></input>
	                <div class="modal-footer">
	                    <apex:outputPanel rendered="{!$CurrentPage.parameters.type == 'new' }">
	                    <a class="btn-bs" onclick="parent.$j('.modal').modal('hide');">Cancel</a>
                        <a class="save-project-contribandgroup btn-bs btn-bs-primary" closeDialog="false" changenext="true">Save &#038; Next</a>
                        <a class="save-project-contribandgroup btn-bs" closeDialog="true">Save &#038; Close</a>
	                    </apex:outputPanel>
	                    <apex:outputPanel rendered="{!$CurrentPage.parameters.type != 'new' }">
	                    <a class="btn-bs" onclick="parent.$j('.modal').modal('hide');">Cancel</a>
                        <a class="save-project-contribandgroup btn-bs btn-bs-primary" closeDialog="false" changenext="false">Save</a>
                        <a class="save-project-contribandgroup btn-bs" closeDialog="true">Save &#038; Close</a>
	                    </apex:outputPanel>
	                </div>
	            </div>
	            <div id="projectSharing" style="display:none;">
	            	<apex:outputPanel rendered="{!sharingEnabled}">
	            	<div class="all-internal-user-sharing-container">
	            		<input type="checkbox" id="allinternaluserscheckbox-share"></input> <label for="allinternaluserscheckbox-share">Share this project to All TaskRay Users</label>
	            	</div>
	            	</apex:outputPanel>
	            	<div style="clear:both;"></div>
	            	<hr style="margin: 4px;"/>
					<div id="sharing-warning" class="alert alert-block">
						<b>This project is PRIVATE.</b><br />
						The users below are currently listed as contributors and have access to this project. Further manage their access by checking the access boxes. Add additional users by using the look-up.
					</div>
		            <input type="hidden" id="project-records-sharing-level" value=""/>
		            <div id="sharing-body" class="">
		                <table id="current-shares-table" class="table table-condensed">
		                    <thead>
		                        <tr>
		                            <th></th>
		                            <th style="min-width:275px;">Name</th>
		                            <th>Read Access</th>
		                            <th>Write Access</th>
		                        </tr>
		                    </thead>
		                    <tbody>
		                    </tbody>    
		                </table>
		                <!-- Look up user(s) to grant additional access to this project &amp; its tasks:&nbsp;<input id="sharing-search-input" type="text" placeholder="Type a name..." style="width:155px;" /> -->
		                <input id="sharing-add-contributor-search" placeholder="Search for a new contributor..." ></input>
		            </div>
		            <div class="modal-footer">
		                <apex:outputPanel rendered="{!$CurrentPage.parameters.type == 'new' }">
	                    <a class="btn-bs" onclick="parent.$j('.modal').modal('hide');">Cancel</a>
                        <a class="save-project-contribandgroup btn-bs btn-bs-primary" closeDialog="false" changenext="true">Save &#038; Next</a>
                        <a class="save-project-contribandgroup btn-bs" closeDialog="true">Save &#038; Close</a>
	                    </apex:outputPanel>
	                    <apex:outputPanel rendered="{!$CurrentPage.parameters.type != 'new' }">
	                    <a class="btn-bs" onclick="parent.$j('.modal').modal('hide');">Cancel</a>
                        <a class="save-project-contribandgroup btn-bs btn-bs-primary" closeDialog="false" changenext="false">Save</a>
                        <a class="save-project-contribandgroup btn-bs" closeDialog="true">Save &#038; Close</a>
	                    </apex:outputPanel>
		            </div>
	            </div>
            </div>
            <!-- end contributors tab -->
            <div class="tab-pane fade in" id="groups" style="width:100%">
                <div class="group-sharing-explanation alert alert-block">Adding a Chatter Group to a Project will allow TaskRay users to see the project in their sidebar list when filtering by a Chatter Group.</div>
                <div>
                    <h4>Add Project to the following Chatter Group filters:</h4><br />
                    <select data-placeholder="Click here to add Chatter groups" id="chatter-groups" multiple="multiple" style="width:350px;" > 
                        <apex:repeat value="{!chatterGroupIds}" var="group">
                            <apex:outputPanel rendered="{!group.shared}"><option selected="selected" value="{!group.Id}">{!group.Name}</option></apex:outputPanel>
                            <apex:outputPanel rendered="{!NOT(group.shared)}"><option value="{!group.Id}">{!group.Name}</option></apex:outputPanel>
                        </apex:repeat>
                    </select>
                    <div class="modal-footer">
                        <a class="btn-bs" onclick="parent.$j('.modal').modal('hide');">Cancel</a>
                        <a class="save-project-contribandgroup btn-bs " closeDialog="false">Save</a>
                        <a class="save-project-contribandgroup btn-bs btn-bs-primary" closeDialog="true">Save &#038; Close</a>
                    </div>
                </div>
            </div>
        </div>

	        <div id="delete-confirm" class="modal" style="display:none;">
	            <div class="modal-header">Delete Project</div>
	            <div class="modal-body">
	                This will delete the project AND the related project tasks. If you
	                do not want to delete tasks, please move them to another project
	                prior to deletion.
	            </div>
	            <div class="modal-footer">
	                <a id="delete-confirm-btn" href="#" class="btn-bs btn-bs-danger">Delete</a>
	                <a onclick="$j('#delete-confirm').modal('hide');" href="#" class="btn-bs">Cancel</a>
	            </div>
	        </div>
	        <div id="archive-confirm" class="modal" style="display:none;">
	            <div class="modal-header"><strong>Archive</strong></div>
	            <div class="modal-body">
	                This will hide <strong>this project, its related tasks, as well as any sub-projects and tasks</strong> on the TaskRay board.<br /><br />
                    You will still be able to access archived projects and tasks using the Archived checkbox as a filter on Projects &amp; Project Tasks in reports and dashboards.
	            </div>
	            <div class="modal-footer">
	                <a id="archive-confirm-btn" href="#" class="btn-bs btn-bs-warning">Archive</a>
	                <a onclick="$j('#archive-confirm').modal('hide');" href="#" class="btn-bs">Cancel</a>
	            </div>
	        </div>
	        <div id="clone-confirm" class="modal" style="display:none;">
	            <div class="modal-header"><h4 style="font-size:14px;">Project Clone</h4></div>
	            <div class="modal-body">
                <div class="alert">
                    <strong>Warning!</strong> Any Projects/Tasks assigned to inactive users will be assigned to you.
                </div>
	            Cloning this project will:
	            <ul>
		            <li>Copy any Chatter Group associations applied to original project</li>
					<li>Copy all field values of both the project and related tasks</li>
					<li>Copy Contributors (or if security is enabled, the security settings and permissions will be copied)</li>
					<li>Set the cloned project to active (cloning an archived project will not create an archived clone)</li>
	            </ul>   
	            New Project Title: <input id="new-project-title" type="text" value="Copy of {!Project__c.Name}" style="width: 98%; font-size: 12px;"/>
                <apex:form >
                <table>
                    <tr class="date-select-container"><td>New Start Date:</td><td><apex:inputField value="{!TASKRAY__Project__c.TASKRAY__Project_Start__c}" styleClass="newCloneStartDate"/></td></tr>
                    <tr class="date-select-container"><td>New End Date:</td><td><apex:inputField value="{!TASKRAY__Project__c.TASKRAY__Project_End__c}" styleClass="newCloneEndDate"/></td></tr>
                </table>
                </apex:form>
                Clone children projects: <input type="checkbox" id="cloneChildren" checked="checked"/><br />
	            </div>
	            <div class="modal-footer">
	                <a id="clone-confirm-btn" href="#" onclick="cloneProject();" class="btn-bs btn-bs-primary" >Clone</a>
	                <a onclick="$j('#clone-confirm').modal('hide');" href="#" class="btn-bs">Cancel</a>
	            </div>      
	        </div>
	        <div id="delete-all-internal-share-modal" class="modal" style="display:none;">
	            <div class="modal-header" style="text-align: center;"><strong>Alert</strong></div>
	            <div class="modal-body">
	                This action will make this project PRIVATE. Any existing users listed as contributors will be provided Read/Write access. Access can be further managed by Project Owners, users higher in the role hierarchy, and System Administrators.
	            </div>
	            <div class="modal-footer">
	                <a onclick="$j('#delete-all-internal-share-modal').modal('hide');" href="#" class="btn-bs">Cancel</a>
	                <a id="delete-all-internal-share-confirm-btn" href="#" class="btn-bs btn-bs-primary">Proceed</a>
	            </div>
	        </div>
	        <div id="add-all-internal-share-modal" class="modal" style="display:none;">
	            <div class="modal-header" style="text-align: center;"><strong>Alert</strong></div>
	            <div class="modal-body">
	                This action will make this project PUBLIC. Any existing users with Read/Write access will be listed as contributors. Access can be further managed by Project Owners, users higher in the role hierarchy, and System Administrators.
	            </div>
	            <div class="modal-footer">
	                <a onclick="$j('#add-all-internal-share-modal').modal('hide');" href="#" class="btn-bs">Cancel</a>
	                <a id="add-all-internal-share-confirm-btn" href="#" class="btn-bs btn-bs-primary">Proceed</a>
	            </div>
	        </div>
    </div>
</div>  
<div id="canvasloader-container" class="wrapper"></div>
<div id="modal-backdrop-loadmask" class="modal-backdrop in" style="display:none;"></div>
</apex:page>